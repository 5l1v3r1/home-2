#!/bin/bash
# info: change vesta port
# options: port
#
# Function change vesta port


#----------------------------------------------------------#
#              Variable & Verifications                    #
#----------------------------------------------------------#

whoami=$(whoami)
if [ "$whoami" != "root" ] && [ "$whoami" != "admin" ] ; then
    echo "You must be root or admin to execute this script";
    exit 1;
fi

if [ -z "$VESTA" ]; then
    VESTA="/usr/local/vesta"
fi

# Includes
source $VESTA/func/main.sh

# Argument definition
port=$1

re='^[0-9]+$'
if ! [[ $port =~ $re ]] ; then
    echo "error: Not a number" >&2; exit 1
fi

if [ ! -f "$VESTA/conf/port.conf" ]; then
    oldport=8083
else
    oldport=`cat $VESTA/conf/port.conf`
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

sed -i "s|$oldport;|$port;|g" $VESTA/nginx/conf/nginx.conf
if [ -f "/etc/roundcube/plugins/password/config.inc.php" ]; then
    sed -i "s|'$oldport'|'$port'|g" /etc/roundcube/plugins/password/config.inc.php
fi
sed -i "s|'$oldport'|'$port'|g" $VESTA/data/firewall/rules.conf
$VESTA/bin/v-update-firewall
systemctl restart fail2ban.service
systemctl restart vesta

echo "$port" > $VESTA/conf/port.conf

#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Logging
log_event "$OK" "$ARGUMENTS"

exit 0;
